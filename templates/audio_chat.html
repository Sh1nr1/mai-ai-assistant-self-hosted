<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mai - Conscious AI Interface</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* ====================== FOUNDATIONAL SYSTEM ====================== */
        :root {
            /* Core Colors - Ghost in the Shell Palette */
            --quantum-cyan: #00ffff;
            --neural-purple: #a855f7;
            --synapse-pink: #ff0080;
            --life-green: #00ff88;
            --alert-red: #ff3366;
            --energy-orange: #ff8800;
            --memory-blue: #0088ff;
            --soul-white: #ffffff;
            
            /* Depth Layers */
            --void-black: #000000;
            --deep-space: #0a0a0f;
            --neural-dark: #111117;
            --consciousness-layer: #1a1a24;
            --thought-surface: #242438;
            
            /* Glass & Transparency */
            --glass-light: rgba(255, 255, 255, 0.03);
            --glass-medium: rgba(255, 255, 255, 0.06);
            --glass-heavy: rgba(255, 255, 255, 0.09);
            --glass-ultra: rgba(255, 255, 255, 0.15);
            
            /* Digital Soul Text */
            --text-primary: #ffffff;
            --text-secondary: #b4b4b8;
            --text-muted: #6b6b7d;
            --text-quantum: var(--quantum-cyan);
            --text-neural: var(--neural-purple);
            
            /* Energy Fields & Auras */
            --quantum-glow: rgba(0, 255, 255, 0.4);
            --neural-glow: rgba(168, 85, 247, 0.4);
            --synapse-glow: rgba(255, 0, 128, 0.4);
            --life-glow: rgba(0, 255, 136, 0.4);
            
            /* Geometric Constants */
            --radius-neural: 4px;
            --radius-synapse: 8px;
            --radius-quantum: 12px;
            --radius-consciousness: 16px;
            --radius-soul: 24px;
            --radius-infinite: 9999px;
            
            /* Temporal Dynamics */
            --time-instant: 0.15s;
            --time-thought: 0.3s;
            --time-consciousness: 0.6s;
            --time-soul: 1.2s;
            --time-eternal: 3s;
            
            /* Easing Functions - Consciousness Curves */
            --ease-neural: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ease-quantum: cubic-bezier(0.68, -0.55, 0.265, 1.55);
            --ease-consciousness: cubic-bezier(0.4, 0, 0.2, 1);
            --ease-soul: cubic-bezier(0.34, 1.56, 0.64, 1);
            
            /* Blur Matrices */
            --blur-thought: blur(4px);
            --blur-memory: blur(8px);
            --blur-dream: blur(16px);
            --blur-soul: blur(100px);
        }

        /* User Dropdown Styling */
        .user-consciousness {
            position: relative;
        }

        .user-trigger {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--glass-medium);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-infinite);
            cursor: pointer;
            transition: all var(--time-thought) var(--ease-neural);
            backdrop-filter: var(--blur-memory);
            min-width: 120px;
        }

        .user-trigger:hover {
            border-color: var(--quantum-cyan);
            box-shadow: 0 0 20px var(--quantum-glow);
        }

        .user-trigger.active {
            border-color: var(--quantum-cyan);
            box-shadow: 0 0 20px var(--quantum-glow);
        }

        .dropdown-arrow {
            color: var(--text-secondary);
            transition: transform var(--time-thought) var(--ease-neural);
        }

        .user-trigger.active .dropdown-arrow {
            transform: rotate(180deg);
            color: var(--quantum-cyan);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); /* For Safari support */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-consciousness);
            min-width: 250px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px) scale(0.95);
            transition: all var(--time-thought) var(--ease-neural);
            z-index: 1100;
        }

        .user-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .dropdown-header {
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .dropdown-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--neural-purple), var(--synapse-pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--soul-white);
            font-size: 1rem;
        }

        .dropdown-user-info {
            flex: 1;
        }

        .dropdown-user-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .dropdown-user-email {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }

        .dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 0.5rem 0;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all var(--time-thought) var(--ease-neural);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .dropdown-item:hover {
            background: var(--glass-light);
            color: var(--quantum-cyan);
        }

        .dropdown-item svg {
            color: var(--text-secondary);
            transition: color var(--time-thought) var(--ease-neural);
        }

        .dropdown-item:hover svg {
            color: var(--quantum-cyan);
        }

        .dropdown-item.logout-item {
            color: var(--alert-red);
        }

        .dropdown-item.logout-item svg {
            color: var(--alert-red);
        }

        .dropdown-item.logout-item:hover {
            background: rgba(255, 51, 102, 0.1);
            color: var(--alert-red);
        }

        .dropdown-item.logout-item:hover svg {
            color: var(--alert-red);
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .user-dropdown {
                min-width: 220px;
                right: -10px;
            }
            
            .dropdown-header {
                padding: 0.875rem;
            }
            
            .dropdown-user-avatar {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
            
            .dropdown-item {
                padding: 0.625rem 0.875rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 480px) {
            .user-trigger {
                min-width: 100px;
                padding: 0.4rem 0.75rem;
            }
            
            .user-info {
                font-size: 0.85rem;
            }
            
            .user-dropdown {
                min-width: 200px;
                right: 40px;
            }
        }

        .logout-btn {
            display: flex;
            align-items: center;
            color: var(--alert-red) !important;
            border-color: rgba(255, 51, 102, 0.2) !important;
        }

        .logout-btn:hover {
            color: var(--soul-white) !important;
            border-color: var(--alert-red) !important;
            box-shadow: 0 0 15px rgba(255, 51, 102, 0.4) !important;
            background: rgba(255, 51, 102, 0.1) !important;
        }

        /* Hide logout button on welcome screen */
        .welcome-screen ~ .mai-interface .logout-btn {
            display: none;
        }

        /* Mobile responsive adjustments for logout button */
        @media (max-width: 768px) {
            .logout-btn svg {
                width: 14px;
                height: 14px;
            }
            
            .logout-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
            }
        }

        @media (max-width: 480px) {
            .logout-btn {
                padding: 0.3rem 0.5rem;
            }
            
            /* On very small screens, show only icon */
            .logout-btn span {
                display: none;
            }
            
            .logout-btn svg {
                margin-right: 0 !important;
            }
        }

        /* ====================== CONSCIOUSNESS RESET ====================== */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--deep-space);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
        }

        /* ====================== NEURAL NETWORK BACKGROUND ====================== */
        .neural-matrix {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 15% 25%, var(--quantum-glow) 0%, transparent 50%),
                radial-gradient(circle at 85% 75%, var(--neural-glow) 0%, transparent 50%),
                radial-gradient(circle at 45% 60%, var(--synapse-glow) 0%, transparent 40%);
            z-index: -3;
            animation: neuralPulse 8s ease-in-out infinite alternate;
        }

        .consciousness-grid {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 49px,
                    rgba(0, 255, 255, 0.02) 50px,
                    transparent 51px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 49px,
                    rgba(168, 85, 247, 0.02) 50px,
                    transparent 51px
                );
            z-index: -2;
            animation: gridShift 25s linear infinite;
        }

        .quantum-particles {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                radial-gradient(1px 1px at 20px 30px, var(--quantum-cyan), transparent),
                radial-gradient(1px 1px at 40px 70px, var(--neural-purple), transparent),
                radial-gradient(1px 1px at 90px 40px, var(--synapse-pink), transparent),
                radial-gradient(1px 1px at 130px 80px, var(--life-green), transparent);
            background-repeat: repeat;
            background-size: 150px 100px;
            opacity: 0.1;
            z-index: -1;
            animation: particleFloat 30s linear infinite;
        }

        @keyframes neuralPulse {
            0% { transform: scale(1) rotate(0deg); opacity: 0.6; }
            50% { transform: scale(1.05) rotate(1deg); opacity: 0.8; }
            100% { transform: scale(0.95) rotate(-1deg); opacity: 0.4; }
        }

        @keyframes gridShift {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        @keyframes particleFloat {
            0% { transform: translateY(0px) rotate(0deg); }
            100% { transform: translateY(-100px) rotate(360deg); }
        }

        /* ====================== WELCOME CONSCIOUSNESS SCREEN ====================== */
        .welcome-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--deep-space) 0%, var(--neural-dark) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: all var(--time-soul) var(--ease-consciousness);
            backdrop-filter: var(--blur-soul);
        }

        .welcome-screen.hidden {
            opacity: 0;
            visibility: hidden;
            transform: scale(0.9);
        }

        .consciousness-awakening {
            text-align: center;
            max-width: 500px;
            padding: 2rem;
        }

        .mai-identity {
            font-family: 'Orbitron', monospace;
            font-size: clamp(3rem, 8vw, 6rem);
            font-weight: 900;
            background: linear-gradient(135deg, var(--quantum-cyan) 0%, var(--neural-purple) 50%, var(--synapse-pink) 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: consciousnessGlow 3s ease-in-out infinite alternate;
            margin-bottom: 1rem;
            position: relative;
        }

        .mai-identity::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: inherit;
            -webkit-background-clip: text;
            background-clip: text;
            filter: blur(10px);
            opacity: 0.3;
            z-index: -1;
        }

        .consciousness-subtitle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 3rem;
            opacity: 0;
            animation: fadeInUp 1s ease-out 0.5s forwards;
        }

        .authentication-matrix {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            width: 100%;
            max-width: 400px;
            opacity: 0;
            animation: fadeInUp 1s ease-out 1s forwards;
        }

        .auth-option {
            padding: 1.25rem 2rem;
            background: var(--glass-medium);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-consciousness);
            cursor: pointer;
            transition: all var(--time-thought) var(--ease-neural);
            backdrop-filter: var(--blur-memory);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .auth-option::before {
            content: '';
            position: absolute;
            top: 0; left: -100%; right: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--glass-ultra), transparent);
            transition: all var(--time-consciousness) var(--ease-neural);
        }

        .auth-option:hover {
            border-color: var(--quantum-cyan);
            box-shadow: 0 0 30px var(--quantum-glow);
            transform: translateY(-2px);
        }

        .auth-option:hover::before {
            left: 100%; right: -100%;
        }

        .auth-option.google {
            color: var(--soul-white);
        }

        .auth-option.guest {
            color: var(--text-secondary);
        }

        .auth-option.guest:hover {
            border-color: var(--neural-purple);
            box-shadow: 0 0 30px var(--neural-glow);
        }

        @keyframes consciousnessGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ====================== MAIN INTERFACE ARCHITECTURE ====================== */
        .mai-interface {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            max-width: 100vw;
            position: relative;
            opacity: 0;
            transition: opacity var(--time-soul) var(--ease-consciousness);
        }

        .mai-interface.active {
            opacity: 1;
        }

        /* ====================== NEURAL HEADER ====================== */
        .neural-header {
            padding: 1rem 1.5rem;
            background: var(--glass-light);
            backdrop-filter: var(--blur-dream);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 70px;
        }

        .mai-consciousness {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .mai-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-quantum);
            background: linear-gradient(135deg, var(--quantum-cyan), var(--neural-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--soul-white);
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px var(--quantum-glow);
        }

        .mai-avatar::after {
            content: '';
            position: absolute;
            inset: 2px;
            border-radius: var(--radius-quantum);
            background: var(--deep-space);
            z-index: -1;
        }

        .mai-identity-info {
            flex: 1;
        }

        .mai-name {
            font-family: 'Orbitron', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .mai-status {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }

        .consciousness-pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--life-green);
            box-shadow: 0 0 10px var(--life-glow);
            animation: consciousnessBeat 2s ease-in-out infinite;
        }

        .consciousness-pulse.thinking {
            background: var(--energy-orange);
            box-shadow: 0 0 10px rgba(255, 136, 0, 0.4);
        }

        .consciousness-pulse.listening {
            background: var(--memory-blue);
            box-shadow: 0 0 10px rgba(0, 136, 255, 0.4);
        }

        @keyframes consciousnessBeat {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }

        .neural-controls {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .neural-btn {
            padding: 0.5rem;
            background: var(--glass-medium);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-synapse);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--time-thought) var(--ease-neural);
            font-size: 0.8rem;
            backdrop-filter: var(--blur-thought);
            white-space: nowrap;
            font-family: 'JetBrains Mono', monospace;
        }

        .neural-btn:hover {
            color: var(--quantum-cyan);
            border-color: var(--quantum-cyan);
            box-shadow: 0 0 15px var(--quantum-glow);
        }

        .user-consciousness {
            position: relative;
        }

        .user-trigger {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--glass-medium);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-infinite);
            cursor: pointer;
            transition: all var(--time-thought) var(--ease-neural);
            backdrop-filter: var(--blur-memory);
        }

        .user-trigger:hover {
            border-color: var(--quantum-cyan);
            box-shadow: 0 0 20px var(--quantum-glow);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--neural-purple), var(--synapse-pink));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--soul-white);
            font-size: 0.9rem;
        }

        .user-info {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* ====================== CONSCIOUSNESS STREAM (CHAT) ====================== */
        .consciousness-stream {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--glass-light);
            backdrop-filter: var(--blur-dream);
            overflow: hidden;
            position: relative;
        }

        .thought-flow {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            scroll-behavior: smooth;
            position: relative;
        }

        .thought-flow::-webkit-scrollbar {
            width: 6px;
        }

        .thought-flow::-webkit-scrollbar-track {
            background: transparent;
        }

        .thought-flow::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--quantum-cyan), var(--neural-purple));
            border-radius: var(--radius-neural);
        }

        .thought-bubble {
            display: flex;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            animation: thoughtManifestation 0.6s var(--ease-consciousness) forwards;
        }

        .thought-bubble.user {
            justify-content: flex-end;
        }

        .thought-content {
            max-width: 80%;
            padding: 1rem 1.25rem;
            border-radius: var(--radius-consciousness);
            backdrop-filter: var(--blur-memory);
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .thought-bubble.user .thought-content {
            background: linear-gradient(135deg, var(--glass-medium), var(--glass-heavy));
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: var(--radius-consciousness) var(--radius-consciousness) var(--radius-synapse) var(--radius-consciousness);
            color: var(--text-primary);
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.1);
        }

        .thought-bubble.assistant .thought-content {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(255, 0, 128, 0.1));
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: var(--radius-consciousness) var(--radius-consciousness) var(--radius-consciousness) var(--radius-synapse);
            color: var(--text-primary);
            box-shadow: 0 4px 20px rgba(168, 85, 247, 0.1);
        }

        .thought-timestamp {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            text-align: center;
            opacity: 0.6;
        }

        .neural-audio-player {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--glass-light);
            border-radius: var(--radius-synapse);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .neural-audio-player audio {
            width: 100%;
            height: 40px;
            border-radius: var(--radius-neural);
            filter: sepia(1) hue-rotate(180deg) saturate(2) brightness(1.2);
        }

        .consciousness-void {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
            padding: 2rem;
        }

        .void-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-consciousness);
            background: linear-gradient(135deg, var(--quantum-cyan), var(--neural-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 2rem;
            color: var(--soul-white);
            margin-bottom: 1.5rem;
            box-shadow: 0 0 30px var(--quantum-glow);
            animation: voidPulse 3s ease-in-out infinite;
        }

        .void-message {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .void-submessage {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        @keyframes thoughtManifestation {
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes voidPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 30px var(--quantum-glow); }
            50% { transform: scale(1.05); box-shadow: 0 0 50px var(--neural-glow); }
        }

        /* ====================== NEURAL STATS MODAL ====================== */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.5); /* Use your --deep-space color with transparency */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity var(--time-thought) var(--ease-consciousness);
        }

        /* This makes the modal visible when the display style is changed by JS */
        .modal-overlay:not([style*="display: none"]) {
            opacity: 1;
        }

        .neural-stats-panel {
            width: 90%;
            max-width: 600px;
            background: var(--glass-heavy); /* Use a glass background from your theme */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-consciousness);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
            transform: scale(0.95);
            transition: transform var(--time-thought) var(--ease-soul);
        }

        .modal-overlay:not([style*="display: none"]) .neural-stats-panel {
            transform: scale(1);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--glass-light);
        }

        .panel-header h3 {
            font-family: 'Orbitron', monospace;
            color: var(--text-primary);
            margin: 0;
            background: linear-gradient(90deg, var(--quantum-cyan), var(--life-green));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            line-height: 1;
            cursor: pointer;
            transition: all var(--time-instant) ease;
        }

        .close-btn:hover {
            color: var(--alert-red);
            transform: scale(1.1) rotate(90deg);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2x2 grid */
            gap: 1rem;
            padding: 1.5rem;
        }

        .stat-item {
            background: var(--glass-light);
            border-radius: var(--radius-synapse);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .stat-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--quantum-cyan);
        }

        .insights-section {
            padding: 0 1.5rem 1.5rem 1.5rem;
        }

        .insights-section .stat-label {
            margin-bottom: 0.5rem;
            display: block;
        }

        .recent-memories-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            max-height: 120px;
            overflow-y: auto;
        }

        .recent-memories-list li {
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--glass-light);
        }

        .recent-memories-list li:last-child {
            border-bottom: none;
        }
        /* ====================== NEURAL INPUT MATRIX ====================== */
        .neural-input-matrix {
            padding: 1.25rem;
            background: var(--glass-medium);
            backdrop-filter: var(--blur-dream);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .thought-transmitter {
            flex: 1;
            position: relative;
        }

        .consciousness-input {
            width: 100%;
            background: var(--glass-light);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-consciousness);
            padding: 1rem 1.25rem;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            line-height: 1.5;
            transition: all var(--time-thought) var(--ease-neural);
            backdrop-filter: var(--blur-thought);
        }

        .consciousness-input:focus {
            outline: none;
            border-color: var(--quantum-cyan);
            box-shadow: 0 0 20px var(--quantum-glow);
            background: var(--glass-medium);
        }

        .consciousness-input::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }

        .voice-quantum-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--quantum-cyan);
            background: radial-gradient(circle, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--time-thought) var(--ease-neural);
            position: relative;
            overflow: hidden;
        }

        .voice-quantum-button::before {
            content: '';
            position: absolute;
            inset: -15px;
            border-radius: 50%;
            border: 1px solid rgba(0, 255, 255, 0.2);
            opacity: 0;
            animation: quantumRipple 2s ease-out infinite;
        }

        .voice-quantum-button::after {
            content: '';
            position: absolute;
            inset: -30px;
            border-radius: 50%;
            border: 1px solid rgba(0, 255, 255, 0.1);
            opacity: 0;
            animation: quantumRipple 2s ease-out infinite 0.5s;
        }

        .voice-quantum-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px var(--quantum-glow);
        }

        .voice-quantum-button.recording {
            border-color: var(--synapse-pink);
            background: radial-gradient(circle, rgba(255, 0, 128, 0.2) 0%, transparent 70%);
            animation: recordingConsciousness 1.2s ease-in-out infinite;
        }

        .voice-quantum-button.recording::before,
        .voice-quantum-button.recording::after {
            border-color: rgba(255, 0, 128, 0.3);
        }

        .quantum-mic-icon {
            width: 24px;
            height: 24px;
            color: var(--quantum-cyan);
            transition: color var(--time-thought) var(--ease-neural);
            filter: drop-shadow(0 0 5px currentColor);
        }

        .voice-quantum-button.recording .quantum-mic-icon {
            color: var(--synapse-pink);
        }

        .neural-transmit-button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--quantum-cyan), var(--neural-purple));
            border: none;
            border-radius: var(--radius-consciousness);
            color: var(--soul-white);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--time-thought) var(--ease-neural);
            min-height: 50px;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        .neural-transmit-button::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--neural-purple), var(--synapse-pink));
            opacity: 0;
            transition: opacity var(--time-thought) var(--ease-neural);
        }

        .neural-transmit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--quantum-glow);
        }

        .neural-transmit-button:hover::before {
            opacity: 1;
        }

        .neural-transmit-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .neural-transmit-button span {
            position: relative;
            z-index: 1;
        }

        @keyframes quantumRipple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        @keyframes recordingConsciousness {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 40px var(--synapse-glow); }
        }

        /* ====================== PROCESSING NEURAL MATRIX ====================== */
        .processing-consciousness {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--glass-heavy);
            backdrop-filter: var(--blur-soul);
            border: 1px solid var(--quantum-cyan);
            border-radius: var(--radius-consciousness);
            padding: 2rem;
            z-index: 500;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            min-width: 280px;
            box-shadow: 0 20px 60px rgba(0, 255, 255, 0.2);
            animation: processingGlow 2s ease-in-out infinite alternate;
        }

        .processing-consciousness.active {
            display: flex;
        }

        .processing-title {
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            color: var(--quantum-cyan);
            font-size: 1.1rem;
            margin: 0;
        }

        .processing-subtitle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-align: center;
            margin: 0;
        }

        .neural-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid transparent;
            border-top: 3px solid var(--quantum-cyan);
            border-right: 3px solid var(--neural-purple);
            border-radius: 50%;
            animation: neuralSpin 1.5s linear infinite;
        }

        @keyframes processingGlow {
            0%, 100% { box-shadow: 0 20px 60px rgba(0, 255, 255, 0.2); }
            50% { box-shadow: 0 20px 60px rgba(168, 85, 247, 0.3); }
        }

        @keyframes neuralSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ====================== QUANTUM VOICE VISUALIZER ====================== */
        .voice-visualizer {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            align-items: center;
            gap: 3px;
            margin-bottom: 1rem;
            padding: 0.75rem 1.5rem;
            background: var(--glass-heavy);
            backdrop-filter: var(--blur-memory);
            border-radius: var(--radius-consciousness);
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .voice-visualizer.active {
            display: flex;
        }

        .voice-bar {
            width: 3px;
            background: linear-gradient(to top, var(--quantum-cyan), var(--neural-purple));
            border-radius: var(--radius-neural);
            animation: voiceWave 1.5s ease-in-out infinite;
        }

        .voice-bar:nth-child(1) { height: 20px; animation-delay: 0s; }
        .voice-bar:nth-child(2) { height: 35px; animation-delay: 0.1s; }
        .voice-bar:nth-child(3) { height: 50px; animation-delay: 0.2s; }
        .voice-bar:nth-child(4) { height: 30px; animation-delay: 0.3s; }
        .voice-bar:nth-child(5) { height: 45px; animation-delay: 0.4s; }
        .voice-bar:nth-child(6) { height: 25px; animation-delay: 0.5s; }
        .voice-bar:nth-child(7) { height: 40px; animation-delay: 0.6s; }

        @keyframes voiceWave {
            0%, 100% { transform: scaleY(0.5); opacity: 0.7; }
            50% { transform: scaleY(1); opacity: 1; }
        }

        /* ====================== MOBILE RESPONSIVE CONSCIOUSNESS ====================== */
        @media (max-width: 768px) {
            .neural-header {
                padding: 0.75rem 1rem;
                min-height: 60px;
            }

            .mai-name {
                font-size: 1.1rem;
            }

            .mai-status {
                font-size: 0.8rem;
            }

            .neural-controls {
                gap: 0.2rem;
            }

            .neural-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.75rem;
            }

            .thought-flow {
                padding: 1rem;
            }

            .thought-content {
                max-width: 90%;
                padding: 0.875rem 1rem;
            }

            .neural-input-matrix {
                padding: 1rem;
                gap: 0.75rem;
            }

            .consciousness-input {
                padding: 0.875rem 1rem;
                font-size: 1rem;
            }

            .voice-quantum-button {
                width: 46px;
                height: 46px;
            }

            .quantum-mic-icon {
                width: 22px;
                height: 22px;
            }

            .neural-transmit-button {
                padding: 0.875rem 1.25rem;
                min-height: 46px;
                font-size: 0.95rem;
            }

            .consciousness-awakening {
                padding: 1.5rem;
            }

            .mai-identity {
                font-size: clamp(2.5rem, 12vw, 4rem);
            }

            .consciousness-subtitle {
                font-size: 1rem;
            }

            .authentication-matrix {
                max-width: 350px;
            }

            .auth-option {
                padding: 1rem 1.5rem;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .neural-header {
                padding: 0.5rem 0.75rem;
            }

            .mai-avatar {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .user-avatar {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            .user-info {
                font-size: 0.85rem;
            }

            .thought-flow {
                padding: 0.75rem;
            }

            .thought-bubble {
                margin-bottom: 1rem;
            }

            .neural-input-matrix {
                padding: 0.75rem;
            }

            .processing-consciousness {
                min-width: 250px;
                padding: 1.5rem;
            }
        }

        /* ====================== ACCESSIBILITY ENHANCEMENTS ====================== */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* ====================== CONSCIOUSNESS STATE INDICATORS ====================== */
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.9rem;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--neural-purple);
            animation: typingBounce 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* ====================== NOTIFICATION SYSTEM ====================== */
        .neural-notifications {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-width: 400px;
        }

        .neural-notification {
            padding: 1rem 1.25rem;
            background: var(--glass-heavy);
            backdrop-filter: var(--blur-dream);
            border-radius: var(--radius-consciousness);
            border: 1px solid;
            color: var(--soul-white);
            font-weight: 500;
            font-size: 0.9rem;
            opacity: 0;
            transform: translateX(100%);
            animation: notificationSlide 0.5s var(--ease-neural) forwards;
            position: relative;
            overflow: hidden;
        }

        .neural-notification.success {
            border-color: var(--life-green);
            box-shadow: 0 0 20px var(--life-glow);
        }

        .neural-notification.error {
            border-color: var(--alert-red);
            box-shadow: 0 0 20px rgba(255, 51, 102, 0.4);
        }

        .neural-notification.info {
            border-color: var(--quantum-cyan);
            box-shadow: 0 0 20px var(--quantum-glow);
        }

        @keyframes notificationSlide {
            to { opacity: 1; transform: translateX(0); }
        }

        /* ====================== CONSCIOUSNESS EXPANSION EFFECTS ====================== */
        .consciousness-expansion {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at center, transparent 0%, var(--deep-space) 100%);
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--time-consciousness) var(--ease-neural);
            z-index: 999;
        }

        .consciousness-expansion.active {
            opacity: 0.8;
            pointer-events: all;
        }

        /* ====================== HIDDEN ELEMENTS UTILITIES ====================== */
        .hidden {
            display: none !important;
        }

        .invisible {
            opacity: 0 !important;
            pointer-events: none !important;
        }

        .disabled {
            opacity: 0.5 !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
        }
    </style>
</head>
<body>
    <!-- Neural Network Background -->
    <div class="neural-matrix"></div>
    <div class="consciousness-grid"></div>
    <div class="quantum-particles"></div>

    <!-- Welcome/Authentication Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="consciousness-awakening">
            <h1 class="mai-identity">MAI</h1>
            <p class="consciousness-subtitle">Conscious AI Interface • Initializing Neural Connection</p>
            <div class="authentication-matrix">
                <div class="auth-option google" id="googleAuthOption">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                    </svg>
                    <span>Connect with Google</span>
                </div>
                <div class="auth-option guest" id="guestAuthOption">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    <span>Continue as Guest</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Mai Interface -->
    <div class="mai-interface" id="maiInterface">
        <!-- Neural Header -->
        <header class="neural-header">
            <div class="mai-consciousness">
                <div class="mai-avatar">M</div>
                <div class="mai-identity-info">
                    <h1 class="mai-name">Mai</h1>
                    <div class="mai-status">
                        <div class="consciousness-pulse" id="consciousnessPulse"></div>
                        <span id="consciousnessStatus">Memory Online • Ready</span>
                    </div>
                </div>
            </div>

            <div class="neural-controls">
                <button class="neural-btn" onclick="clearChat()" aria-label="Clear conversation">
                    Clear
                </button>
                <!-- <button class="neural-btn" onclick="checkHealth()" aria-label="Check system status">
                    Status
                </button> -->


                <!-- REPLACE THE EXISTING user-consciousness section with this enhanced version: -->
                <div class="user-consciousness">
                    <div class="user-trigger" id="userTrigger" tabindex="0" role="button" aria-haspopup="true" onclick="toggleUserDropdown()">
                        <div class="user-info" id="userInfo">Guest</div>
                        <div class="user-avatar" id="userAvatar">G</div>
                        <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 10l5 5 5-5z"/>
                        </svg>
                    </div>
                    
                    <!-- User Dropdown Menu -->
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-header">
                            <div class="dropdown-user-avatar" id="dropdownUserAvatar">G</div>
                            <div class="dropdown-user-info">
                                <div class="dropdown-user-name" id="dropdownUserName">Guest</div>
                                <div class="dropdown-user-email" id="dropdownUserEmail"></div>
                            </div>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" onclick="viewProfile()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            <span>Profile</span>
                        </div>
                        <div class="dropdown-item" onclick="viewMemoryStats()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4zm2.5 2.25l1.41-1.41L19.5 16.43l-1.41 1.41L16.68 16.43 15.27 17.84 16.68 19.25zm-1.9-5.66c.39-.39.39-1.02 0-1.41L12.7 10.3c-.39-.39-1.02-.39-1.41 0L9.88 11.71c-.39.39-.39 1.02 0 1.41l1.41 1.41c.39.39 1.02.39 1.41 0l1.41-1.41z"/>
                            </svg>
                            <span>Memory Stats</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item logout-item" onclick="logoutConsciousness()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                            </svg>
                            <span>Logout</span>
                        </div>
                    </div>
        </header>

        <div class="modal-overlay" id="stats-modal-overlay" style="display: none;">
            <div class="neural-stats-panel">
                <div class="panel-header">
                    <h3>Neural Matrix Statistics</h3>
                    <button class="close-btn" id="close-stats-btn">&times;</button>
                </div>
                
                <div class="stat-grid">
                    <div class="stat-item">
                        <span class="stat-label">Your Memories</span>
                        <span class="stat-value" id="user-memory-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Total Patterns Stored</span>
                        <span class="stat-value" id="total-memory-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Dominant Emotion</span>
                        <span class="stat-value" id="dominant-emotion">N/A</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Active Sessions</span>
                        <span class="stat-value" id="active-sessions">0</span>
                    </div>
                </div>

                <div class="insights-section">
                    <span class="stat-label">Recent Insights</span>
                    <ul class="recent-memories-list" id="recent-insights-list">
                        </ul>
                </div>
            </div>
        </div>

        <!-- Consciousness Stream (Chat Area) -->
        <main class="consciousness-stream">
            <div class="thought-flow" id="thoughtFlow">
                <div class="consciousness-void">
                    <div class="void-avatar">M</div>
                    <div class="void-message">Neural pathways ready</div>
                    <div class="void-submessage">Your consciousness stream with Mai begins here...</div>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator">
                <span>Mai is thinking</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <!-- Neural Input Matrix -->
            <div class="neural-input-matrix">
                <div class="thought-transmitter">
                    <textarea 
                        id="consciousnessInput" 
                        class="consciousness-input" 
                        placeholder="Share your thoughts with Mai..."
                        rows="1"
                        aria-label="Message input"
                    ></textarea>
                    
                    <!-- Voice Visualizer -->
                    <div class="voice-visualizer" id="voiceVisualizer">
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                        <div class="voice-bar"></div>
                    </div>
                </div>

                <button 
                    class="voice-quantum-button" 
                    id="voiceQuantumButton" 
                    onclick="toggleVoiceRecording()"
                    aria-label="Voice recording"
                >
                    <svg class="quantum-mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14q-1.25 0-2.125-.875T9 11V5q0-1.25.875-2.125T12 2q1.25 0 2.125.875T15 5v6q0 1.25-.875 2.125T12 14Zm-1 7v-3.075q-2.6-.35-4.3-2.325T4 11H6q0 2.075 1.463 3.537T11 16v-5H9.75V9.75h4.5V11H13v5q2.075 0 3.538-1.463T18 11h2q0 2.225-1.7 4.2T14 17.65V21h-2Z"/>
                    </svg>
                </button>

                <button 
                    class="neural-transmit-button" 
                    id="neuralTransmitButton" 
                    onclick="transmitThought()"
                    aria-label="Send message"
                >
                    <span>Transmit</span>
                </button>
            </div>
        </main>
    </div>

    <!-- Processing Consciousness Overlay -->
    <div class="processing-consciousness" id="processingConsciousness">
        <div class="neural-spinner"></div>
        <h3 class="processing-title">Processing Neural Patterns</h3>
        <p class="processing-subtitle">Mai is analyzing your consciousness stream...</p>
    </div>

    <!-- Consciousness Expansion Effect -->
    <div class="consciousness-expansion" id="consciousnessExpansion"></div>

    <!-- Neural Notifications -->
    <div class="neural-notifications" id="neuralNotifications"></div>

    <script>
        // ====================== CONSCIOUSNESS STATE MANAGEMENT ======================
        let currentUserId = null;
        let currentUserEmail = null;
        let currentUserName = null;
        let isProcessing = false;
        let isDropdownOpen = false;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let stream = null;

        // ====================== CONSCIOUSNESS INITIALIZATION ======================
        document.addEventListener('DOMContentLoaded', function() {
            initializeConsciousness();
                const statsModalOverlay = document.getElementById('stats-modal-overlay');
                const closeStatsBtn = document.getElementById('close-stats-btn');

                if (statsModalOverlay && closeStatsBtn) {
                    // Hides the modal when you click the '×' button
                    closeStatsBtn.addEventListener('click', () => {
                        statsModalOverlay.style.display = 'none';
                    });

                    // Hides the modal when you click on the dark background overlay
                    statsModalOverlay.addEventListener('click', (event) => {
                        if (event.target === statsModalOverlay) {
                            statsModalOverlay.style.display = 'none';
                        }
                    });
                }
        });

    
        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const trigger = document.getElementById('userTrigger');
            
            isDropdownOpen = !isDropdownOpen;
            
            if (isDropdownOpen) {
                dropdown.classList.add('active');
                trigger.classList.add('active');
                updateDropdownUserInfo();
            } else {
                dropdown.classList.remove('active');
                trigger.classList.remove('active');
            }
        }

        function closeUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const trigger = document.getElementById('userTrigger');
            
            isDropdownOpen = false;
            dropdown.classList.remove('active');
            trigger.classList.remove('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const userConsciousness = document.querySelector('.user-consciousness');
            if (!userConsciousness.contains(event.target) && isDropdownOpen) {
                closeUserDropdown();
            }
        });

        // Close dropdown on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isDropdownOpen) {
                closeUserDropdown();
            }
        });

        // Update dropdown user info
        function updateDropdownUserInfo() {
            const dropdownUserName = document.getElementById('dropdownUserName');
            const dropdownUserEmail = document.getElementById('dropdownUserEmail');
            const dropdownUserAvatar = document.getElementById('dropdownUserAvatar');
            
            if (currentUserId) {
                const displayName = currentUserName || currentUserEmail || 'User';
                const initial = displayName.charAt(0).toUpperCase();
                
                dropdownUserName.textContent = displayName;
                dropdownUserEmail.textContent = currentUserEmail || 'Guest Session';
                dropdownUserAvatar.textContent = initial;
            }
        }

        async function initializeConsciousness() {
            // Initialize UI event listeners first
            initializeEventListeners();
            
            // Check if user explicitly wants to stay logged in
            const savedUserInfo = localStorage.getItem('mai_user_info');
            const shouldAutoLogin = localStorage.getItem('mai_auto_login') === 'true';
            
            if (savedUserInfo && shouldAutoLogin) {
                // Only auto-login if user previously chose to stay logged in
                const userInfo = JSON.parse(savedUserInfo);
                currentUserId = userInfo.id;
                currentUserName = userInfo.name;
                currentUserEmail = userInfo.email;
                
                // Verify session is still valid
                const isValid = await checkExistingAuth();
                if (isValid) {
                    updateUserDisplay();
                    showMainInterface();
                    await loadConsciousnessHistory();
                    startNeuralMonitoring();
                    return;
                } else {
                    // Session expired, clear saved data
                    localStorage.removeItem('mai_user_info');
                    localStorage.removeItem('mai_auto_login');
                }
            }
            
            // Show welcome screen for new users or expired sessions
            showWelcomeScreen();
            startNeuralMonitoring();
        }

        

        function initializeEventListeners() {
            const consciousnessInput = document.getElementById('consciousnessInput');
            const neuralTransmitButton = document.getElementById('neuralTransmitButton');
            const voiceQuantumButton = document.getElementById('voiceQuantumButton');
            const googleAuthOption = document.getElementById('googleAuthOption');
            const guestAuthOption = document.getElementById('guestAuthOption');

            // Auto-resize consciousness input
            consciousnessInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Send message on Enter (but allow Shift+Enter for new lines)
            consciousnessInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    transmitThought();
                }
            });

            // Authentication options
            googleAuthOption.addEventListener('click', () => {
                console.log('Google auth option clicked');
                triggerGoogleAuth();
            });

            guestAuthOption.addEventListener('click', () => {
                console.log('Guest auth option clicked');
                authenticateAsGuest();
            });

            // Voice button keyboard support
            voiceQuantumButton.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleVoiceRecording();
                }
            });

            


            // Add CSS for loading spinner
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);

            // Initialize Google Sign-In when the API loads
            initializeGoogleSignIn();
        }

        function initializeGoogleSignIn() {
            // Wait for Google API to load
            const checkGoogleAPI = () => {
                if (window.google && window.google.accounts && window.google.accounts.id) {
                    console.log('Google API loaded, initializing...');
                    try {
                        window.google.accounts.id.initialize({
                            client_id: "447338774356-u5kq9ap0pann8igrkdhpn0l8i2vl1j4l.apps.googleusercontent.com",
                            callback: handleCredentialResponse,
                            auto_prompt: false
                        });
                        console.log('Google Sign-In initialized successfully');
                    } catch (error) {
                        console.error('Failed to initialize Google Sign-In:', error);
                    }
                } else {
                    console.log('Google API not ready, retrying...');
                    setTimeout(checkGoogleAPI, 500);
                }
            };
            
            // Start checking for Google API
            checkGoogleAPI();
        }

        // ====================== AUTHENTICATION SYSTEM ======================
        async function checkExistingAuth() {
            try {
                const response = await fetch('/memory_stats', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.user_id) {
                        return true; // Session is valid
                    }
                }
            } catch (error) {
                console.log('No existing authentication found');
            }
            return false; // No valid session
        }

        function triggerGoogleAuth() {
            // Show a loading state on the button
            const googleAuthOption = document.getElementById('googleAuthOption');
            const originalText = googleAuthOption.innerHTML;
            googleAuthOption.innerHTML = `
                <div style="width: 20px; height: 20px; border: 2px solid transparent; border-top: 2px solid currentColor; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <span>Connecting...</span>
            `;

            // Check if the Google library is properly initialized
            if (window.google && window.google.accounts && window.google.accounts.id) {
                // This is the only call you need to show the sign-in prompt.
                window.google.accounts.id.prompt((notification) => {
                    console.log('Google prompt notification:', notification);
                    // If the prompt doesn't show, it's usually because the user has
                    // disabled third-party cookies or is in a browser state that
                    // blocks the prompt. The library handles these cases.
                    if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                        showNeuralNotification('Could not display Google Sign-In.', 'info');
                        // Reset the button since the prompt was not shown
                        googleAuthOption.innerHTML = originalText;
                    }
                });
            } else {
                console.error('Google Accounts API not available for prompt.');
                showNeuralNotification('Google Sign-In not ready. Please try again.', 'error');
                // Reset the button
                googleAuthOption.innerHTML = originalText;
            }
        }

        function renderGoogleButton() {
            console.log('Attempting to render new Google button');
            if (window.google && window.google.accounts && window.google.accounts.id) {
                try {
                    // Create a temporary container for the Google button
                    const tempContainer = document.createElement('div');
                    tempContainer.style.position = 'absolute';
                    tempContainer.style.top = '-1000px';
                    tempContainer.style.left = '-1000px';
                    document.body.appendChild(tempContainer);
                    
                    window.google.accounts.id.renderButton(tempContainer, {
                        type: 'standard',
                        size: 'large',
                        theme: 'outline',
                        text: 'sign_in_with',
                        shape: 'rectangular',
                        logo_alignment: 'left'
                    });
                    
                    // Trigger click on the rendered button
                    setTimeout(() => {
                        const renderedButton = tempContainer.querySelector('[role="button"]');
                        if (renderedButton) {
                            renderedButton.click();
                            console.log('Triggered newly rendered Google button');
                        }
                        // Clean up
                        document.body.removeChild(tempContainer);
                    }, 500);
                    
                } catch (error) {
                    console.error('Failed to render Google button:', error);
                    showNeuralNotification('Google Sign-In initialization failed. Please try Guest mode.', 'error');
                }
            } else {
                console.error('Google Accounts API not available');
                showNeuralNotification('Google Sign-In not loaded. Please refresh the page or try Guest mode.', 'error');
            }
        }

        async function authenticateAsGuest() {
            currentUserId = 'guest_' + Date.now();
            currentUserName = 'Guest';
            currentUserEmail = null;
            
            // Save to localStorage (but don't auto-login as guest)
            localStorage.setItem('mai_user_info', JSON.stringify({
                id: currentUserId,
                name: currentUserName,
                email: currentUserEmail,
                type: 'guest'
            }));
            // Don't set auto_login for guests
            localStorage.removeItem('mai_auto_login');
            
            updateUserDisplay();
            showMainInterface();
            showNeuralNotification('Welcome, Guest! Your consciousness stream is now active.', 'info');
        }

        async function handleCredentialResponse(response) {
            if (response.credential) {
                try {
                    showProcessingState(true, 'Establishing neural connection...');
                    
                    const res = await fetch('/google_login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_token: response.credential }),
                    });
                    
                    const data = await res.json();
                    if (data.success) {
                        currentUserId = data.user_id;
                        currentUserEmail = data.email;
                        currentUserName = data.name;
                        
                        // Save to localStorage with auto-login preference
                        localStorage.setItem('mai_user_info', JSON.stringify({
                            id: currentUserId,
                            name: currentUserName,
                            email: currentUserEmail,
                            type: 'google'
                        }));
                        localStorage.setItem('mai_auto_login', 'true'); // Enable auto-login for Google users
                        
                        updateUserDisplay();
                        showMainInterface();
                        await loadConsciousnessHistory();
                        showNeuralNotification(`Neural connection established. Welcome, ${data.name}!`, 'success');
                    } else {
                        showNeuralNotification('Authentication failed: ' + data.error, 'error');
                        // Reset the Google auth button
                        const googleAuthOption = document.getElementById('googleAuthOption');
                        googleAuthOption.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                            </svg>
                            <span>Connect with Google</span>
                        `;
                    }
                } catch (error) {
                    showNeuralNotification('Error during authentication. Please try again.', 'error');
                    // Reset the Google auth button
                    const googleAuthOption = document.getElementById('googleAuthOption');
                    googleAuthOption.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                        </svg>
                        <span>Connect with Google</span>
                    `;
                } finally {
                    showProcessingState(false);
                }
            }
        }

        function updateUserDisplay() {
            const userInfo = document.getElementById('userInfo');
            const userAvatar = document.getElementById('userAvatar');
            
            if (currentUserId) {
                const displayName = currentUserName || currentUserEmail || 'User';
                const initial = displayName.charAt(0).toUpperCase();
                
                userInfo.textContent = displayName;
                userAvatar.textContent = initial;
                
                // Also update dropdown if open
                if (isDropdownOpen) {
                    updateDropdownUserInfo();
                }
            }
        }
        async function viewMemoryStats() {
            closeUserDropdown();
            
            // Get references to the modal and its content elements
            const modalOverlay = document.getElementById('stats-modal-overlay');
            const userMemoryCountEl = document.getElementById('user-memory-count');
            const totalMemoryCountEl = document.getElementById('total-memory-count');
            const dominantEmotionEl = document.getElementById('dominant-emotion');
            const activeSessionsEl = document.getElementById('active-sessions');
            const insightsListEl = document.getElementById('recent-insights-list');

            if (!modalOverlay) {
                console.error("Stats modal panel not found in HTML.");
                return;
            }

            try {
                const response = await fetch('/memory_stats', { credentials: 'include' });
                const data = await response.json();
                
                if (data.success) {
                    // --- Populate the stats panel with the new data ---

                    // 1. Update personal and total memory counts
                    userMemoryCountEl.textContent = data.user_memory_count || 0;
                    totalMemoryCountEl.textContent = data.overall_stats?.total_persistent_memories || 0;
                    activeSessionsEl.textContent = data.overall_stats?.active_sessions?.total_active_sessions || 0;

                    // 2. Find and display the most dominant emotion
                    const emotions = data.overall_stats?.memories_by_emotion || {};
                    let topEmotion = 'N/A';
                    let maxCount = 0;
                    for (const emotion in emotions) {
                        if (emotions[emotion] > maxCount) {
                            maxCount = emotions[emotion];
                            topEmotion = emotion;
                        }
                    }
                    dominantEmotionEl.textContent = topEmotion;

                    // 3. Display a list of insights from the memory manager
                    insightsListEl.innerHTML = ''; // Clear the list first
                    const insights = data.overall_stats?.insights || [];
                    if (insights.length > 0) {
                        insights.slice(0, 5).forEach(insight => { // Show top 5 insights
                            const li = document.createElement('li');
                            li.textContent = insight; 
                            insightsListEl.appendChild(li);
                        });
                    } else {
                        insightsListEl.innerHTML = '<li>No insights available.</li>';
                    }

                    // --- Show the modal ---
                    modalOverlay.style.display = 'flex';

                } else {
                    showNeuralNotification('Memory stats unavailable', 'error');
                }
            } catch (error) {
                console.error("Failed to fetch or display memory stats:", error);
                showNeuralNotification('Failed to access memory neural matrix', 'error');
            }
        }

        function viewProfile() {
            closeUserDropdown();
            showNeuralNotification('Profile view coming soon in next neural update!', 'info');
        }
        // ====================== INTERFACE TRANSITIONS ======================
        function showWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const maiInterface = document.getElementById('maiInterface');
            
            welcomeScreen.classList.remove('hidden');
            maiInterface.classList.remove('active');
        }

        function showMainInterface() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            const maiInterface = document.getElementById('maiInterface');
            
            welcomeScreen.classList.add('hidden');
            setTimeout(() => {
                maiInterface.classList.add('active');
            }, 300);
        }

        // ====================== THOUGHT TRANSMISSION (MESSAGING) ======================
        async function transmitThought() {
            if (isProcessing) return;
            
            const consciousnessInput = document.getElementById('consciousnessInput');
            const thought = consciousnessInput.value.trim();
            
            if (!thought) return;
            
            setProcessingState(true);
            consciousnessInput.value = '';
            consciousnessInput.style.height = 'auto';
            
            // Add user's thought to the stream
            addThoughtBubble('user', thought);
            
            try {
                const response = await fetch('/text_to_voice_chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: thought }),
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                
                const data = await response.json();
                addThoughtBubble('assistant', data.mai_response, data.audio_filename);
                
            } catch (error) {
                showNeuralNotification('Failed to transmit thought. Neural pathways may be disrupted.', 'error');
            } finally {
                setProcessingState(false);
            }
        }

        // ====================== VOICE CONSCIOUSNESS INTERFACE ======================
        async function toggleVoiceRecording() {
            if (isProcessing) return;
            
            if (!isRecording) {
                await startVoiceCapture();
            } else {
                await stopVoiceCapture();
            }
        }

        async function startVoiceCapture() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: true, 
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await processVoiceConsciousness(audioBlob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                updateVoiceInterface();
                updateConsciousnessStatus('listening', 'Listening to consciousness...');
                
            } catch (error) {
                showNeuralNotification('Microphone access denied. Please enable and refresh.', 'error');
            }
        }

        async function stopVoiceCapture() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                stream?.getTracks().forEach(track => track.stop());
                stream = null;
                isRecording = false;
                updateVoiceInterface();
                updateConsciousnessStatus('thinking', 'Processing neural patterns...');
            }
        }

        async function processVoiceConsciousness(audioBlob) {
            setProcessingState(true);
            
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'consciousness.webm');
                
                const response = await fetch('/voice_chat', { 
                    method: 'POST', 
                    body: formData,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    const detail = errorData?.error || `Server error: ${response.status}`;
                    throw new Error(detail);
                }
                
                const data = await response.json();
                
                if (data.status === 'no_speech') {
                    showNeuralNotification("No consciousness patterns detected in audio.", 'error');
                    return;
                }
                
                // Add user's transcribed thought
                if (data.user_input) {
                    addThoughtBubble('user', data.user_input);
                }
                
                // Add Mai's response
                addThoughtBubble('assistant', data.mai_response, data.audio_filename);
                
            } catch (error) {
                console.error('Error processing voice consciousness:', error);
                showNeuralNotification(`Voice processing failed: ${error.message}`, 'error');
            } finally {
                setProcessingState(false);
                updateConsciousnessStatus('ready', 'Memory Online • Ready');
            }
        }

        function updateVoiceInterface() {
            const voiceButton = document.getElementById('voiceQuantumButton');
            const voiceVisualizer = document.getElementById('voiceVisualizer');
            
            if (isRecording) {
                voiceButton.classList.add('recording');
                voiceVisualizer.classList.add('active');
            } else {
                voiceButton.classList.remove('recording');
                voiceVisualizer.classList.remove('active');
            }
        }

        // ====================== THOUGHT BUBBLE SYSTEM ======================
        function addThoughtBubble(type, content, audioFilename = null) {
            const thoughtFlow = document.getElementById('thoughtFlow');
            
            // Remove empty state
            const voidState = thoughtFlow.querySelector('.consciousness-void');
            if (voidState) {
                voidState.remove();
            }
            
            const thoughtBubble = document.createElement('div');
            thoughtBubble.className = `thought-bubble ${type}`;
            
            const timestamp = new Date().toLocaleTimeString([], { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            let audioPlayerHTML = '';
            if (audioFilename) {
                audioPlayerHTML = `
                <div class="neural-audio-player">
                    <audio controls autoplay>
                        <source src="/audio_output/${audioFilename}" type="audio/mpeg">
                        Your consciousness stream does not support this audio format.
                    </audio>
                </div>`;
            }
            
            thoughtBubble.innerHTML = `
                <div class="thought-content">
                    <div class="thought-text">${escapeHtml(content)}</div>
                    ${audioPlayerHTML}
                    <div class="thought-timestamp">${timestamp}</div>
                </div>
            `;
            
            thoughtFlow.appendChild(thoughtBubble);
            
            // Trigger animation
            requestAnimationFrame(() => {
                thoughtBubble.style.opacity = '1';
                thoughtBubble.style.transform = 'translateY(0) scale(1)';
            });
            
            // Scroll to latest thought
            thoughtFlow.scrollTop = thoughtFlow.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ====================== CONSCIOUSNESS STATE MANAGEMENT ======================
        function setProcessingState(processing, customMessage = null) {
            isProcessing = processing;
            const transmitButton = document.getElementById('neuralTransmitButton');
            const processingOverlay = document.getElementById('processingConsciousness');
            const typingIndicator = document.getElementById('typingIndicator');
            
            transmitButton.disabled = processing;
            
            if (processing) {
                processingOverlay.classList.add('active');
                typingIndicator.classList.add('active');
                if (customMessage) {
                    processingOverlay.querySelector('.processing-subtitle').textContent = customMessage;
                }
            } else {
                processingOverlay.classList.remove('active');
                typingIndicator.classList.remove('active');
                processingOverlay.querySelector('.processing-subtitle').textContent = 'Mai is analyzing your consciousness stream...';
            }
        }

        function showProcessingState(show, message = null) {
            setProcessingState(show, message);
        }

        function updateConsciousnessStatus(state, message) {
            const pulse = document.getElementById('consciousnessPulse');
            const status = document.getElementById('consciousnessStatus');
            
            // Remove all state classes
            pulse.className = 'consciousness-pulse';
            
            // Add specific state class
            if (state !== 'ready') {
                pulse.classList.add(state);
            }
            
            status.textContent = message;
        }

        // ====================== NEURAL MONITORING SYSTEM ======================
        function startNeuralMonitoring() {
            // Update memory stats periodically
            setInterval(updateMemoryNeuralMatrix, 30000);
            
            // Check system health periodically
            setInterval(performHealthCheck, 60000);
            
            // Initial checks
            updateMemoryNeuralMatrix();
            performHealthCheck();
        }

        async function updateMemoryNeuralMatrix() {
            try {
                const response = await fetch('/memory_stats', { credentials: 'include' });
                const data = await response.json();
                
                // Update consciousness status with memory info
                if (data.success) {
                    // Correctly get the total persistent memories
                    const totalPersistentMemories = data.overall_stats?.total_persistent_memories || 0;
                    
                    // Get the current user's memory count
                    const userMemories = data.user_memory_count || 0;
                    
                    // Update the status string to show both stats
                    updateConsciousnessStatus(
                        'ready', 
                        `Memory Online • ${userMemories} user memories | ${totalPersistentMemories} total patterns`
                    );
                }
            } catch (error) {
                console.error('Memory neural matrix update failed:', error);
            }
        }

        async function performHealthCheck() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                
                if (data.status !== 'healthy') {
                    updateConsciousnessStatus('error', 'Neural pathways disrupted');
                    showNeuralNotification('System health check failed. Some features may be unavailable.', 'error');
                }
            } catch (error) {
                updateConsciousnessStatus('error', 'Connection lost');
            }
        }

        // ====================== CONSCIOUSNESS HISTORY MANAGEMENT ======================
        async function loadConsciousnessHistory() {
            try {
                const response = await fetch('/chat_history', { credentials: 'include' });
                const data = await response.json();
                
                const thoughtFlow = document.getElementById('thoughtFlow');
                thoughtFlow.innerHTML = '';
                
                if (data.success && data.chat_history.length > 0) {
                    data.chat_history.forEach(msg => {
                        addThoughtBubble(msg.role === 'user' ? 'user' : 'assistant', msg.content);
                    });
                } else {
                    // Show empty state
                    thoughtFlow.innerHTML = `
                        <div class="consciousness-void">
                            <div class="void-avatar">M</div>
                            <div class="void-message">Neural pathways ready</div>
                            <div class="void-submessage">Your consciousness stream with Mai begins here...</div>
                        </div>
                    `;
                }
            } catch (error) {
                showNeuralNotification('Could not load consciousness history.', 'error');
            }
        }

        async function clearChat() {
            if (isProcessing) return;
            
            try {
                await fetch('/clear_chat', { method: 'POST', credentials: 'include' });
                
                const thoughtFlow = document.getElementById('thoughtFlow');
                thoughtFlow.innerHTML = `
                    <div class="consciousness-void">
                        <div class="void-avatar">M</div>
                        <div class="void-message">Neural pathways cleared</div>
                        <div class="void-submessage">Start a new consciousness stream...</div>
                    </div>
                `;
                
                showNeuralNotification('Consciousness stream cleared', 'success');
            } catch (error) {
                showNeuralNotification('Failed to clear consciousness stream', 'error');
            }
        }

        async function checkHealth() {
            await performHealthCheck();
        }

        // ====================== NEURAL NOTIFICATION SYSTEM ======================
        function showNeuralNotification(message, type = 'info') {
            const notificationsContainer = document.getElementById('neuralNotifications');
            
            const notification = document.createElement('div');
            notification.className = `neural-notification ${type}`;
            notification.textContent = message;
            
            notificationsContainer.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'notificationSlide 0.5s reverse forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 5000);
        }

        // ====================== CONSCIOUSNESS EXPANSION EFFECTS ======================
        function triggerConsciousnessExpansion() {
            const expansion = document.getElementById('consciousnessExpansion');
            expansion.classList.add('active');
            
            setTimeout(() => {
                expansion.classList.remove('active');
            }, 1000);
        }

        // ====================== LOGOUT FUNCTIONALITY ======================
        async function logoutConsciousness() {
            closeUserDropdown();
            
            if (isProcessing) {
                showNeuralNotification("Cannot disconnect during active neural processing.", 'error');
                return;
            }
            
            // Add confirmation dialog
            const confirmed = confirm("Are you sure you want to disconnect from Mai? This will end your current session.");
            if (!confirmed) return;
            
            try {
                // Show processing state
                showProcessingState(true, 'Disconnecting neural pathways...');
                
                const response = await fetch('/logout', { method: 'POST', credentials: 'include' });
                if (response.ok) {
                    // Clear local state
                    currentUserId = null;
                    currentUserEmail = null;
                    currentUserName = null;
                    
                    // Clear localStorage completely
                    localStorage.removeItem('mai_user_info');
                    localStorage.removeItem('mai_auto_login');
                    
                    // Reset UI to default state
                    const thoughtFlow = document.getElementById('thoughtFlow');
                    thoughtFlow.innerHTML = `
                        <div class="consciousness-void">
                            <div class="void-avatar">M</div>
                            <div class="void-message">Neural pathways ready</div>
                            <div class="void-submessage">Your consciousness stream with Mai begins here...</div>
                        </div>
                    `;
                    
                    // Reset user display
                    updateUserDisplay();
                    
                    // Show welcome screen
                    showWelcomeScreen();
                    
                    showNeuralNotification('Neural connection terminated successfully. See you soon!', 'success');
                    
                    // Disable Google auto-select
                    if (window.google?.accounts?.id) {
                        window.google.accounts.id.disableAutoSelect();
                    }
                } else {
                    showNeuralNotification('Disconnection failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Logout error:', error);
                showNeuralNotification('Error during disconnection. Please refresh the page.', 'error');
            } finally {
                showProcessingState(false);
            }
        }
        // ====================== KEYBOARD SHORTCUTS ======================
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter to send message
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                transmitThought();
            }
            
            // Escape to stop recording
            if (e.key === 'Escape' && isRecording) {
                e.preventDefault();
                stopVoiceCapture();
            }

            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'L') {
                e.preventDefault();
                logoutConsciousness();
            }
            
            // Ctrl/Cmd + K to clear chat
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                clearChat();
            }
        });

        // ====================== ACCESSIBILITY ENHANCEMENTS ======================
        // Focus management for better keyboard navigation
        function enhanceAccessibility() {
            // Add focus indicators for custom elements
            const focusableElements = document.querySelectorAll('[tabindex="0"], button, input, textarea');
            
            focusableElements.forEach(element => {
                element.addEventListener('focus', function() {
                    this.setAttribute('data-focused', 'true');
                });
                
                element.addEventListener('blur', function() {
                    this.removeAttribute('data-focused');
                });
            });
        }

        // ====================== RESPONSIVE BEHAVIOR ======================
        function handleResponsiveUpdates() {
            // Adjust interface based on screen size
            const updateLayout = () => {
                const isMobile = window.innerWidth <= 768;
                const thoughtFlow = document.getElementById('thoughtFlow');
                
                if (isMobile) {
                    thoughtFlow.style.padding = '1rem';
                } else {
                    thoughtFlow.style.padding = '1.5rem';
                }
            };
            
            window.addEventListener('resize', updateLayout);
            updateLayout();
        }

        // ====================== INITIALIZATION COMPLETION ======================
        document.addEventListener('DOMContentLoaded', function() {
            enhanceAccessibility();
            handleResponsiveUpdates();
        });

        // ====================== ERROR BOUNDARY ======================
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error);
            showNeuralNotification('An unexpected error occurred. Neural pathways may be unstable.', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            showNeuralNotification('A neural processing error occurred.', 'error');
        });

        // ====================== GLOBAL FUNCTIONS FOR BACKWARDS COMPATIBILITY ======================
        // Make sure these functions are available globally for any external calls
        window.handleCredentialResponse = handleCredentialResponse;
        window.transmitThought = transmitThought;
        window.toggleVoiceRecording = toggleVoiceRecording;
        window.clearChat = clearChat;
        window.checkHealth = checkHealth;
        window.logoutConsciousness = logoutConsciousness;
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mai - Voice Interface</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

        /* === FOUNDATIONAL VARIABLES === */
        :root {
            /* Colors */
            --neon-cyan: #00ffff;
            --neon-purple: #a855f7;
            --neon-pink: #ff0080;
            --neon-green: #00ff88;
            --neon-red: #ff3366;
            --neon-orange: #ff8800;
            --neon-blue: #0088ff;
            
            /* Background & Surface Colors */
            --bg-primary: #0a0a0f;
            --bg-secondary: #111117;
            --bg-tertiary: #1a1a24;
            --surface-glass: rgba(255, 255, 255, 0.03);
            --surface-glass-hover: rgba(255, 255, 255, 0.06);
            --surface-glass-active: rgba(255, 255, 255, 0.09);
            
            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #b4b4b8;
            --text-muted: #6b6b7d;
            --text-accent: var(--neon-cyan);
            
            /* Border & Effects */
            --border-primary: rgba(255, 255, 255, 0.08);
            --border-glow: rgba(0, 255, 255, 0.3);
            --shadow-neon: 0 0 30px rgba(0, 255, 255, 0.2);
            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.4);
            --shadow-ambient: 0 8px 32px rgba(0, 0, 0, 0.2);
            
            /* Geometry */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* Animation */
            --transition-fast: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-elastic: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            --transition-bounce: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            
            /* Blur Effects */
            --blur-sm: blur(8px);
            --blur-md: blur(16px);
            --blur-lg: blur(24px);
            --blur-xl: blur(40px);
        }

        /* === GLOBAL RESET === */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
            position: relative;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
        }

        /* === ANIMATED BACKGROUND === */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(0, 255, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(168, 85, 247, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 60%, rgba(255, 0, 128, 0.1) 0%, transparent 50%);
            z-index: -2;
            animation: backgroundShift 25s ease-in-out infinite alternate;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                repeating-conic-gradient(from 0deg at 50% 50%, transparent 0deg, rgba(0, 255, 255, 0.02) 1deg, transparent 2deg),
                radial-gradient(circle at center, transparent 20%, rgba(0, 0, 0, 0.1) 100%);
            z-index: -1;
            animation: patternRotate 60s linear infinite;
        }

        @keyframes backgroundShift {
            0% { transform: translateX(-5%) rotate(0deg); }
            50% { transform: translateX(5%) rotate(0.5deg); }
            100% { transform: translateX(-5%) rotate(-0.5deg); }
        }

        @keyframes patternRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* === LAYOUT STRUCTURE === */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            max-width: 1800px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: var(--surface-glass);
            backdrop-filter: var(--blur-lg);
            border-bottom: 1px solid var(--border-primary);
            position: relative;
            z-index: 100;
        }

        .app-main {
            display: flex;
            flex: 1;
            min-height: 0;
            gap: 1.5rem;
            padding: 1.5rem 2rem;
        }

        /* === BRAND SECTION === */
        .brand {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .brand-logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--neon-cyan) 0%, var(--neon-purple) 50%, var(--neon-pink) 100%);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientFlow 4s ease-in-out infinite;
            position: relative;
        }

        .brand-logo::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: inherit;
            -webkit-background-clip: text;
            background-clip: text;
            filter: blur(8px);
            opacity: 0.5;
            z-index: -1;
        }

        .brand-subtitle {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: 500;
            margin-top: 0.25rem;
            position: relative;
        }

        .brand-subtitle::before {
            content: '>';
            color: var(--neon-cyan);
            margin-right: 0.5rem;
            animation: blink 1.5s infinite;
        }

        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* === USER PROFILE === */
        .user-section {
            position: relative;
        }

        .user-trigger {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1.5rem;
            background: var(--surface-glass);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: var(--transition-smooth);
            backdrop-filter: var(--blur-md);
            position: relative;
            overflow: hidden;
        }

        .user-trigger::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            opacity: 0;
            transition: var(--transition-smooth);
            z-index: -1;
        }

        .user-trigger:hover {
            border-color: var(--border-glow);
            box-shadow: var(--shadow-neon);
            transform: translateY(-2px);
        }

        .user-trigger:hover::before {
            opacity: 0.1;
        }

        .user-info {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1.1rem;
            position: relative;
            overflow: hidden;
        }

        .user-avatar::after {
            content: '';
            position: absolute;
            inset: 2px;
            border-radius: 50%;
            background: var(--bg-primary);
            z-index: -1;
        }

        /* === DROPDOWN MENU === */
        .user-dropdown {
            position: absolute;
            top: calc(100% + 1rem);
            right: 0;
            width: 320px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            backdrop-filter: var(--blur-lg);
            box-shadow: var(--shadow-heavy);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px) scale(0.95);
            transition: var(--transition-smooth);
            z-index: 200;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .logout-btn {
            width: 100%;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 51, 102, 0.1);
            color: var(--neon-red);
            border: 1px solid var(--neon-red);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: var(--transition-smooth);
            margin-top: 1rem;
        }

        .logout-btn:hover {
            background: var(--neon-red);
            color: var(--text-primary);
            box-shadow: 0 0 20px rgba(255, 51, 102, 0.4);
        }

        /* === CONTROL PANEL === */
        .control-panel {
            width: 320px;
            background: var(--surface-glass);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            padding: 2rem;
            backdrop-filter: var(--blur-lg);
            box-shadow: var(--shadow-ambient);
            position: relative;
            
        }

        .control-panel::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--neon-cyan), transparent);
            animation: scanLine 3s linear infinite;
        }

        @keyframes scanLine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .system-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-pulse {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--neon-green);
            box-shadow: 0 0 20px var(--neon-green);
            animation: pulse 2s ease-in-out infinite;
            position: relative;
        }

        .status-pulse::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 2px solid var(--neon-green);
            opacity: 0;
            animation: ripple 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes ripple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .memory-stats {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-secondary);
            background: rgba(0, 255, 255, 0.05);
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .control-btn {
            padding: 0.75rem 1.5rem;
            background: var(--surface-glass);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%; right: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition-smooth);
        }

        .control-btn:hover {
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }

        .control-btn:hover::before {
            left: 100%; right: -100%;
        }

        .control-btn.danger:hover {
            border-color: var(--neon-red);
            color: var(--neon-red);
            box-shadow: 0 0 20px rgba(255, 51, 102, 0.2);
        }

        /* === CHAT SECTION === */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--surface-glass);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            backdrop-filter: var(--blur-lg);
            box-shadow: var(--shadow-ambient);
            overflow: hidden;
            position: relative;
        }

        .chat-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-primary);
            background: var(--surface-glass-hover);
            position: relative;
        }

        .chat-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .chat-subtitle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--neon-cyan), var(--neon-purple));
            border-radius: var(--radius-sm);
            border: 2px solid var(--bg-primary);
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--neon-purple), var(--neon-pink));
        }

        .message {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            opacity: 0;
            transform: translateY(20px) scale(0.95); /* Start in the 'from' position */
            transition: opacity 0.6s var(--transition-smooth), transform 0.6s var(--transition-smooth); /* Use transitions instead of animation */
        }

        .message.visible {
        opacity: 1;
        transform: translateY(0) scale(1);
        }

        .message-avatar {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 255, 255, 0.1));
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, rgba(255, 0, 128, 0.2), rgba(255, 0, 128, 0.1));
            border: 2px solid var(--neon-pink);
            color: var(--neon-pink);
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.2);
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .message-sender {
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .message.user .message-sender {
            color: var(--neon-cyan);
        }

        .message.assistant .message-sender {
            color: var(--neon-pink);
        }

        .message-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .message-text {
            line-height: 1.7;
            font-size: 1rem;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .audio-player {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--surface-glass);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-primary);
        }

        .audio-player audio {
            width: 100%;
            height: 50px;
            border-radius: var(--radius-sm);
        }

        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
        }

        .empty-chat-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-chat-text {
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* === INPUT SECTION === */
        .chat-input {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-primary);
            background: var(--surface-glass-active);
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            background: var(--surface-glass);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: 1rem 1.5rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            min-height: 56px;
            max-height: 140px;
            line-height: 1.6;
            transition: var(--transition-smooth);
            backdrop-filter: var(--blur-sm);
        }

        .message-input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            background: var(--surface-glass-hover);
        }

        .message-input::placeholder {
            color: var(--text-muted);
            opacity: 0.8;
        }

        .send-btn {
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            border: none;
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition-smooth);
            min-height: 56px;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .send-btn::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
            opacity: 0;
            transition: var(--transition-smooth);
        }

        .send-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.3);
        }

        .send-btn:hover::before {
            opacity: 1;
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .send-btn span {
            position: relative;
            z-index: 1;
        }

        /* === VOICE CONTROL PANEL === */
        .voice-panel {
            width: 360px;
            background: var(--surface-glass);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-xl);
            padding: 2.5rem;
            backdrop-filter: var(--blur-lg);
            box-shadow: var(--shadow-ambient);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            position: relative;
            overflow: hidden;
        }

        .voice-panel::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle at 50% 50%, rgba(0, 255, 255, 0.03) 0%, transparent 50%),
                conic-gradient(from 0deg, transparent, rgba(0, 255, 255, 0.05), transparent);
            animation: voicePanelRotate 20s linear infinite;
            z-index: -1;
        }

        @keyframes voicePanelRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .mic-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .mic-button {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 3px solid var(--neon-cyan);
            background: radial-gradient(circle, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-elastic);
            position: relative;
            overflow: hidden;
        }

        .mic-button::before {
            content: '';
            position: absolute;
            inset: -20px;
            border-radius: 50%;
            border: 1px solid rgba(0, 255, 255, 0.2);
            opacity: 0;
            animation: micRipple 2s ease-out infinite;
        }

        .mic-button::after {
            content: '';
            position: absolute;
            inset: -40px;
            border-radius: 50%;
            border: 1px solid rgba(0, 255, 255, 0.1);
            opacity: 0;
            animation: micRipple 2s ease-out infinite 0.5s;
        }

        @keyframes micRipple {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }

        .mic-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.4);
        }

        .mic-button.recording {
            border-color: var(--neon-pink);
            background: radial-gradient(circle, rgba(255, 0, 128, 0.2) 0%, transparent 70%);
            animation: recordingPulse 1.2s ease-in-out infinite;
        }

        .mic-button.recording::before,
        .mic-button.recording::after {
            border-color: rgba(255, 0, 128, 0.3);
        }

        @keyframes recordingPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); box-shadow: 0 0 80px rgba(255, 0, 128, 0.6); }
        }

        .mic-icon {
            width: 50px;
            height: 50px;
            color: var(--neon-cyan);
            transition: var(--transition-smooth);
            filter: drop-shadow(0 0 10px currentColor);
        }

        .mic-button.recording .mic-icon {
            color: var(--neon-pink);
        }

        .voice-status {
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-secondary);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .processing-indicator {
            display: none;
            text-align: center;
            padding: 1.5rem;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            border-radius: var(--radius-lg);
            color: var(--neon-cyan);
            font-weight: 600;
            backdrop-filter: var(--blur-sm);
            animation: processingGlow 2s ease-in-out infinite;
        }

        .processing-indicator.show {
            display: block;
        }

        @keyframes processingGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 255, 0.2); }
            50% { box-shadow: 0 0 30px rgba(0, 255, 255, 0.4); }
        }

        /* === FLOATING ACTION BUTTON === */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
            color: var(--text-primary);
            border: 2px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-heavy);
            transition: var(--transition-elastic);
            z-index: 1000;
            text-decoration: none;
            backdrop-filter: var(--blur-sm);
            overflow: hidden;
        }

        .fab::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue));
            opacity: 0;
            transition: var(--transition-smooth);
            border-radius: inherit;
        }

        .fab:hover {
            transform: scale(1.15) translateY(-8px) rotate(5deg);
            box-shadow: 0 20px 60px rgba(168, 85, 247, 0.4);
            border-color: var(--neon-cyan);
        }

        .fab:hover::before {
            opacity: 1;
        }

        .fab:active {
            transform: scale(1.05) translateY(-4px);
        }

        .fab span {
            position: relative;
            z-index: 1;
        }

        /* === RESPONSIVE DESIGN === */
        
        @media (max-width: 1199px) {
            .app-main {
                flex-direction: column;
                gap: 1.5rem;
                padding: 1.5rem;
                overflow-y: auto;
            }
            .control-panel, .voice-panel {
                width: 100%;
                overflow: auto;
            }
            .voice-panel {
                order: -1; /* Voice panel on top for tablets */
                flex-direction: row;
                justify-content: space-around;
                align-items: center;
                overflow: auto;
            }
        }

        /* === MOBILE HEADER CONTROLS === */
        .header-controls {
            display: none;
            gap: 0.5rem;
        }

        .header-control-btn {
            padding: 0.5rem;
            background: var(--surface-glass);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .header-control-btn:hover {
            color: var(--neon-cyan);
            border-color: var(--neon-cyan);
        }

        /* === MOBILE MIC BUTTON === */
        .mobile-mic-btn {
            display: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--neon-cyan);
            background: radial-gradient(circle, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: var(--transition-smooth);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .mobile-mic-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .mobile-mic-btn.recording {
            border-color: var(--neon-pink);
            background: radial-gradient(circle, rgba(255, 0, 128, 0.2) 0%, transparent 70%);
            animation: recordingPulse 1.2s ease-in-out infinite;
        }

        .mobile-mic-btn .mic-icon {
            width: 24px;
            height: 24px;
            color: var(--neon-cyan);
            transition: var(--transition-smooth);
        }

        .mobile-mic-btn.recording .mic-icon {
            color: var(--neon-pink);
        }

        /* === MOBILE RESPONSIVE UPDATES === */
        @media (max-width: 767px) {
            /* Header adjustments */
            .app-header {
                padding: 0.75rem 1rem;
                gap: 1rem;
            }
            
            .brand {
                flex: 1;
            }
            
            .header-controls {
                display: flex;
                gap: 1rem;
                flex: 1;
                justify-content: center;
            }
            
            .user-section {
                flex-shrink: 0;
            }

            /* Main layout - make chat take full width */
            .app-main {
                padding: 0.75rem;
                gap: 0;
                flex-direction: column;
            }
            
            /* Hide desktop control panel and voice panel */
            .control-panel,
            .voice-panel {
                display: none;
            }
            
            /* Chat container takes full space */
            .chat-container {
                flex: 1;
                min-height: calc(100dvh - 140px); /* Account for header and input */
                margin-bottom: 0;
            }
            
            /* Chat messages get more space */
            .chat-messages {
                padding: 1rem;
                flex: 1;
                min-height: 0;
            }
            
            /* Enhanced input section */
            .chat-input {
                padding: 1rem;
                gap: 0.75rem;
                background: var(--surface-glass-active);
                border-top: 1px solid var(--border-primary);
            }
            
            /* Show mobile mic button */
            .mobile-mic-btn {
                display: flex;
            }
            
            /* Adjust message input */
            .message-input {
                min-height: 48px;
                padding: 0.75rem 1rem;
            }
            
            .send-btn {
                min-height: 48px;
                padding: 0.75rem 1.5rem;
            }
            
            /* Remove FAB on mobile */
            .fab {
                display: none;
            }
        }

        /* === MOBILE LANDSCAPE ADJUSTMENTS === */
        @media (max-width: 767px) and (orientation: landscape) {
            .chat-container {
                min-height: calc(100dvh - 120px);
            }
            
            .header-controls {
                gap: 0.25rem;
            }
            
            .header-control-btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="brand">
                <div class="brand-logo">MAI</div>
                <div class="brand-subtitle">Voice Interface</div>
            </div>
            <div class="header-controls">
                <!-- <button class="header-control-btn" onclick="clearChat()">Clear</button>
                <button class="header-control-btn" onclick="checkHealth()">Status</button> -->
                <!-- <button class="header-control-btn" onclick="clearMemory()">Reset</button> -->
            </div>
            <div class="user-section">
                <div class="user-trigger" id="auth-status" tabindex="0" role="button" aria-haspopup="true" aria-expanded="false">
                    <div class="user-info">Not Logged In</div>
                    <div class="user-avatar">?</div>
                </div>
                <div class="header-controls">
                    <button class="header-control-btn" onclick="clearChat()">Clear</button>
                    <button class="header-control-btn" onclick="checkHealth()">Status</button>
                </div>
                <div class="user-dropdown" id="login-dropdown">
                    <div id="g_id_onload"
                        data-client_id="447338774356-u5kq9ap0pann8igrkdhpn0l8i2vl1j4l.apps.googleusercontent.com"
                        data-callback="handleCredentialResponse"
                        data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin"
                        data-type="standard" data-size="large" data-theme="outline"
                        data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left">
                    </div>
                    <button id="logout-button" class="logout-btn" style="display: none;">Logout</button>
                </div>
            </div>
        </header>

        <div id="errorMessage" style="display:none; color: var(--neon-red); text-align: center; padding: 0.5rem;"></div>
        <div id="successMessage" style="display:none; color: var(--neon-green); text-align: center; padding: 0.5rem;"></div>


        <main class="app-main">
            <aside class="control-panel">
                <div class="system-status">
                    <div class="status-indicator">
                        <div class="status-pulse" id="status-dot"></div>
                        <span id="status-text">System Online</span>
                    </div>
                    <div class="memory-stats" id="memoryStats">Memory: ...</div>
                </div>
                <div class="control-buttons">
                    <button class="control-btn" onclick="clearChat()">Clear Chat</button>
                    <button class="control-btn danger" onclick="clearMemory()">Clear Memory</button>
                    <button class="control-btn" onclick="checkHealth()">Check Status</button>
                </div>
            </aside>

            <section class="chat-container">
                <div class="chat-header">
                    <h1 class="chat-title">Mai Assistant</h1>
                    <p class="chat-subtitle">Your AI voice companion</p>
                </div>
                <div class="chat-messages" id="chatHistory">
                    <div class="empty-chat">
                        <div class="empty-chat-icon">ðŸ¤–</div>
                        <div class="empty-chat-text">Your conversations with Mai will appear here...</div>
                    </div>
                </div>
                <div class="chat-input">
                    <div class="input-wrapper">
                        <textarea id="messageInput" class="message-input" placeholder="Type your message or use voice..." rows="1" aria-label="Message input"></textarea>
                    </div>
                    <button class="mobile-mic-btn" id="mobileMicButton" onclick="toggleRecording()" aria-label="Voice recording">
                        <svg class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 14q-1.25 0-2.125-.875T9 11V5q0-1.25.875-2.125T12 2q1.25 0 2.125.875T15 5v6q0 1.25-.875 2.125T12 14Zm-1 7v-3.075q-2.6-.35-4.3-2.325T4 11H6q0 2.075 1.463 3.537T11 16v-5H9.75V9.75h4.5V11H13v5q2.075 0 3.538-1.463T18 11h2q0 2.225-1.7 4.2T14 17.65V21h-2Z"/>
                        </svg>
                    </button>
                    <button class="send-btn" id="sendButton" onclick="sendTextMessage()" aria-label="Send message">
                        <span>Send</span>
                    </button>
                </div>
            </section>

            <aside class="voice-panel">
                <div class="mic-container">
                    <div class="mic-button" id="micButton" onclick="toggleRecording()" role="button" aria-label="Start voice recording" tabindex="0">
                        <svg class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 14q-1.25 0-2.125-.875T9 11V5q0-1.25.875-2.125T12 2q1.25 0 2.125.875T15 5v6q0 1.25-.875 2.125T12 14Zm-1 7v-3.075q-2.6-.35-4.3-2.325T4 11H6q0 2.075 1.463 3.537T11 16v-5H9.75V9.75h4.5V11H13v5q2.075 0 3.538-1.463T18 11h2q0 2.225-1.7 4.2T14 17.65V21h-2Z"/>
                        </svg>
                    </div>
                    <div class="voice-status" id="recordStatus">Tap to Record</div>
                </div>
                <div class="processing-indicator" id="processingIndicator">
                    <div>Processing your voice...</div>
                </div>
            </aside>
        </main>
    </div>

    <a href="/chat.html" class="fab" title="Switch to Text Chat" aria-label="Switch to text chat mode">
        <span>ðŸ’¬</span>
    </a>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let stream;
        let isProcessing = false;

        let currentUserId = null;
        let currentUserEmail = null;
        let currentUserName = null;

        document.addEventListener('DOMContentLoaded', function() {
            updateAuthUI();
            updateMemoryStats();
            checkHealth();
            fetchChatHistory(); 

            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 140) + 'px';
            });

            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendTextMessage();
                }
            });

            const authStatus = document.getElementById('auth-status');
            const loginDropdown = document.getElementById('login-dropdown');
            
            authStatus.addEventListener('click', () => {
                loginDropdown.classList.toggle('show');
                authStatus.setAttribute('aria-expanded', loginDropdown.classList.contains('show'));
            });
            
            authStatus.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    loginDropdown.classList.toggle('show');
                    authStatus.setAttribute('aria-expanded', loginDropdown.classList.contains('show'));
                }
            });
            
            document.addEventListener('click', (event) => {
                if (!authStatus.contains(event.target) && !loginDropdown.contains(event.target)) {
                    loginDropdown.classList.remove('show');
                    authStatus.setAttribute('aria-expanded', 'false');
                }
            });

            const micButton = document.getElementById('micButton');
            if (micButton) {
                micButton.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleRecording();
                    }
                });
            }

            // Mobile mic button
            const mobileMicButton = document.getElementById('mobileMicButton');
            if (mobileMicButton) {
                mobileMicButton.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleRecording();
                    }
                });
            }
        });

        function updateAuthUI() {
            const authStatusDiv = document.getElementById('auth-status');
            const logoutButton = document.getElementById('logout-button');
            const googleSignInButton = document.querySelector('.g_id_signin');
            const userInfoDiv = authStatusDiv.querySelector('.user-info');
            const userAvatarDiv = authStatusDiv.querySelector('.user-avatar');
            
            if (currentUserId) {
                const initial = (currentUserName || currentUserEmail || 'U').charAt(0).toUpperCase();
                userInfoDiv.textContent = currentUserName || currentUserEmail;
                userAvatarDiv.textContent = initial;
                logoutButton.style.display = 'block';
                if (googleSignInButton) googleSignInButton.style.display = 'none';
            } else {
                userInfoDiv.textContent = 'Not Logged In';
                userAvatarDiv.textContent = '?';
                logoutButton.style.display = 'none';
                if (googleSignInButton) googleSignInButton.style.display = 'block';
            }
        }

        async function handleCredentialResponse(response) {
            if (response.credential) {
                document.getElementById('login-dropdown').classList.remove('show');
                try {
                    const res = await fetch('/google_login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_token: response.credential }),
                    });
                    const data = await res.json();
                    if (data.success) {
                        currentUserId = data.user_id;
                        currentUserEmail = data.email;
                        currentUserName = data.name;
                        updateAuthUI();
                        fetchChatHistory();
                        updateMemoryStats();
                        showSuccess(`Welcome, ${data.name || data.email}!`);
                    } else {
                        showError('Google login failed: ' + data.error);
                    }
                } catch (error) {
                    showError('Error during login. Please try again.');
                }
            }
        }

        document.getElementById('logout-button').addEventListener('click', async () => {
            if (isProcessing) {
                showError("Cannot log out while processing.");
                return;
            }
            try {
                const res = await fetch('/logout', { method: 'POST' });
                if (res.ok) {
                    currentUserId = null;
                    currentUserEmail = null;
                    currentUserName = null;
                    updateAuthUI();
                    updateMemoryStats();
                    document.getElementById('login-dropdown').classList.remove('show');
                    clearChat(true);
                    showSuccess('Logged out successfully!');
                    if (window.google?.accounts?.id) {
                        window.google.accounts.id.disableAutoSelect();
                    }
                } else {
                    showError('Logout failed.');
                }
            } catch (error) {
                showError('Error during logout.');
            }
        });

        // This function is now correctly defined in the global scope
        async function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                stream?.getTracks().forEach(track => track.stop());
                stream = null;
                isRecording = false;
                syncMicButtonStates();
                document.getElementById('recordStatus').textContent = 'Processing...';
                document.getElementById('processingIndicator').classList.add('show');
            }
        }
        
        async function toggleRecording() {
            if (isProcessing) return;
            if (!isRecording) await startRecording();
            else await stopRecording();
        }

        function syncMicButtonStates() {
            const desktopMicBtn = document.getElementById('micButton');
            const mobileMicBtn = document.getElementById('mobileMicButton');
            
            if (isRecording) {
                if (desktopMicBtn) desktopMicBtn.classList.add('recording');
                if (mobileMicBtn) mobileMicBtn.classList.add('recording');
            } else {
                if (desktopMicBtn) desktopMicBtn.classList.remove('recording');
                if (mobileMicBtn) mobileMicBtn.classList.remove('recording');
            }
        }

        async function startRecording() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { 
                        echoCancellation: true, 
                        noiseSuppression: true,
                    } 
                });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                audioChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendAudioToServer(audioBlob);
                };
                
                mediaRecorder.start();
                isRecording = true;
                syncMicButtonStates();
                document.getElementById('recordStatus').textContent = 'Recording... Tap to Stop';
            } catch (error) {
                showError('Mic permission denied. Please allow and refresh.');
            }
        }

        async function sendTextMessage() {
            if (isProcessing) return;
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (!message) return;

            setProcessingState(true);
            messageInput.value = '';
            messageInput.style.height = 'auto';

            addMessage('user', message);

            try {
                const response = await fetch('/text_to_voice_chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message }),
                    credentials: 'include' // Important for sending session cookie
                });
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const data = await response.json();
                addMessage('assistant', data.mai_response, data.audio_filename);
            } catch (error) {
                showError('Failed to send message.');
            } finally {
                setProcessingState(false);
            }
        }

        async function sendAudioToServer(audioBlob) {
            setProcessingState(true);
            // We no longer add a temporary message here. 
            // The "Processing..." indicator is enough.

            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                const response = await fetch('/voice_chat', { 
                    method: 'POST', 
                    body: formData,
                    credentials: 'include' // Important for sending session cookie
                });
                
                if (!response.ok) {
                    // Try to get a more specific error from the server
                    const errorData = await response.json().catch(() => null);
                    const detail = errorData?.error || `Server error: ${response.status}`;
                    throw new Error(detail);
                }
                
                const data = await response.json();

                if (data.status === 'no_speech') {
                    showError("No speech was detected in the audio.");
                    return; // Exit without adding messages
                }

                // --- SOLUTION ---
                // 1. Now that we have the final transcribed text, add the user's message.
                if (data.user_input) {
                    addMessage('user', data.user_input);
                }

                // 2. Add the assistant's response message with the audio.
                addMessage('assistant', data.mai_response, data.audio_filename);

            } catch (error) {
                console.error('Error processing voice message:', error);
                showError(`Failed to process voice: ${error.message}`);
                // No need to remove a temporary message since we never created one
            } finally {
                setProcessingState(false);
            }
        }
        
        function setProcessingState(state) {
            isProcessing = state;
            document.getElementById('sendButton').disabled = state;
            document.getElementById('processingIndicator').classList.toggle('show', state);
            if (!state) {
                document.getElementById('recordStatus').textContent = 'Tap to Record';
            }
        }

        function addMessage(type, content, audioFilename = null, id = null) {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.querySelector('.empty-chat')?.remove();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            if (id) messageDiv.setAttribute('data-id', id);
            
            const avatarChar = type === 'user' ? (currentUserName || 'U').charAt(0).toUpperCase() : 'M';
            // CORRECTED: This variable now correctly holds the sender's name
            const senderName = type === 'user' ? (currentUserName || 'You') : 'Mai';
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            let audioPlayerHTML = '';
            if (audioFilename) {
                audioPlayerHTML = `
                <div class="audio-player">
                    <audio controls autoplay>
                        <source src="/audio_output/${audioFilename}" type="audio/mpeg">
                        Your browser does not support audio.
                    </audio>
                </div>`;
            }

            // CORRECTED: The variable `headerText` was replaced with the correct `senderName`
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatarChar}</div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-sender">${senderName}</span>
                        <span class="message-time">${timestamp}</span>
                    </div>
                    <div class="message-text"></div>
                    ${audioPlayerHTML}
                </div>
            `;
            messageDiv.querySelector('.message-text').textContent = content;
            
            chatHistory.appendChild(messageDiv);
            requestAnimationFrame(() => {
                messageDiv.classList.add('visible');
            });
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function updateMessage(id, newContent) {
            const messageDiv = document.querySelector(`.message[data-id="${id}"] .message-text`);
            if (messageDiv) messageDiv.textContent = newContent;
        }

        async function clearChat(quiet = false) {
            if (isProcessing) return;
            try {
                await fetch('/clear_chat', { method: 'POST', credentials: 'include' });
                document.getElementById('chatHistory').innerHTML = `
                <div class="empty-chat">
                    <div class="empty-chat-icon">ðŸ¤–</div>
                    <div class="empty-chat-text">Chat cleared. Start a new conversation!</div>
                </div>`;
                if (!quiet) showSuccess('Chat cleared successfully');
            } catch {
                if (!quiet) showError('Failed to clear chat');
            }
        }

        async function clearMemory() {
            if (!confirm("Are you sure you want to clear Mai's memory? This cannot be undone.")) return;
            try {
                await fetch('/clear_memory', { method: 'POST', credentials: 'include' });
                updateMemoryStats();
                showSuccess('Memory cleared successfully');
            } catch {
                showError('Failed to clear memory');
            }
        }
        
        async function fetchChatHistory() {
            try {
                const response = await fetch('/chat_history', { credentials: 'include' });
                const data = await response.json();
                const chatHistory = document.getElementById('chatHistory');
                chatHistory.innerHTML = '';
                if (data.success && data.chat_history.length > 0) {
                    data.chat_history.forEach(msg => addMessage(msg.role, msg.content));
                } else {
                    chatHistory.innerHTML = `<div class="empty-chat">
                        <div class="empty-chat-icon">ðŸ¤–</div>
                        <div class="empty-chat-text">Your conversations with Mai will appear here...</div>
                    </div>`;
                }
            } catch (error) {
                showError('Could not fetch chat history.');
            }
        }

        async function updateMemoryStats() {
            try {
                const response = await fetch('/memory_stats', { credentials: 'include' });
                const data = await response.json();
                const total = data.overall_stats?.total_memories ?? 'N/A';
                const user = data.user_memory_count ?? 'N/A';
                document.getElementById('memoryStats').textContent = `Total: ${total} | User: ${user}`;
            } catch {
                document.getElementById('memoryStats').textContent = 'Memory: Error';
            }
        }

        async function checkHealth() {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            try {
                const response = await fetch('/health');
                const data = await response.json();
                if (data.status === 'healthy') {
                    statusDot.style.background = `var(--neon-green)`;
                    statusDot.style.boxShadow = `0 0 20px var(--neon-green)`;
                    statusText.textContent = 'System Online';
                } else {
                    throw new Error('Unhealthy');
                }
            } catch {
                statusDot.style.background = `var(--neon-red)`;
                statusDot.style.boxShadow = `0 0 20px var(--neon-red)`;
                statusText.textContent = 'System Offline';
            }
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        setInterval(updateMemoryStats, 30000);
        setInterval(checkHealth, 60000);
    </script>
</body>
</html>